<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2026-02-25 三 15:31 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>How to Mock Environment Variables in Unit Tests</title>
<meta name="author" content="zhuhy" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/themes/danliden/css/orgbase.css">
<link rel="stylesheet" type="text/css" href="/themes/danliden/css/orgstyle.css">
<script charset="UTF-8" id="LA_COLLECT" src="//sdk.51.la/js-sdk-pro.min.js"></script>
<script>LA.init({id:"3J1LdRG6wZ4yWQly",ck:"3J1LdRG6wZ4yWQly"})</script>
<script src="/statics/scripts/dark-mode.js" defer></script>
</head>
<body>
<div id="preamble" class="status">
<hr class="topnav-rule"/>
<header class="site-header">
  <a href="/" class="site-header__brand">
    <h2>LaoZhuZhu</h2>
  </a>
  <nav class="topnav-links" aria-label="Primary">
    <a href="/posts.html">文章</a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <a class="topnav-icon" href="/rss.xml" aria-label="RSS feed">
      <svg class="rss-icon" viewBox="0 0 24 24" aria-hidden="true" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
        <path d="M5 4h1a14 14 0 0 1 14 14v1"/>
        <path d="M5 11h1a7 7 0 0 1 7 7v1"/>
        <circle cx="6" cy="18" r="2"/>
      </svg>
    </a>
    <span class="topnav-divider" aria-hidden="true">/</span>
    <button id="theme-toggle" class="nav-theme-toggle topnav-icon" type="button" aria-label="Switch to dark mode" aria-pressed="false">
        <svg class="theme-icon" viewBox="0 0 24 24" aria-hidden="true" fill="currentColor">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z"/>
        </svg>
    </button>
  </nav>
</header>
<hr class="topnav-rule"/>
</div>
<div id="content" class="content">
<h1 class="title">How to Mock Environment Variables in Unit Tests</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgbf5e2f8">1. 原文地址</a></li>
<li><a href="#org9942a9b">2. Overview</a></li>
<li><a href="#org346610d">3. The Challenge of Changing Environment Variables</a>
<ul>
<li><a href="#org78ee8ce">3.1. Why the Environment Is Immutable</a></li>
<li><a href="#org4953067">3.2. Working Around the Unmodifiable Map</a></li>
<li><a href="#orgde8978a">3.3. When Reflective Access Doesn’t Work</a></li>
<li><a href="#org08a7ffb">3.4. Why We Need to Set Environment Variables Programmatically</a></li>
<li><a href="#orgb12d192">3.5. Getting the Right Help From Test Libraries</a></li>
</ul>
</li>
<li><a href="#orgdee55a8">4. Setting Environment Variables With JUnit Pioneer</a>
<ul>
<li><a href="#org5db6e65">4.1. Using the SetEnvironmentVariable Annotation</a></li>
<li><a href="#orgb453a57">4.2. Clearing an Environment Variable</a></li>
<li><a href="#orge0ee184">4.3. Limitations of JUnit Pioneer</a></li>
</ul>
</li>
<li><a href="#org9a90a92">5. Setting Environment Variables With System Stubs</a>
<ul>
<li><a href="#orgc97e3aa">5.1. Setting Environment Variables in JUnit 5</a></li>
<li><a href="#org8d9aa54">5.2. Setting Environment Variables in JUnit 4</a></li>
<li><a href="#org04f34b4">5.3. Setting Environment Variables in TestNG</a></li>
<li><a href="#org9768456">5.4. System Stubs Without a Test Framework</a></li>
<li><a href="#org2600290">5.5. Limitations of System Stubs</a></li>
</ul>
</li>
<li><a href="#org590d002">6. System Rules and System Lambda</a>
<ul>
<li><a href="#orgd645dd0">6.1. Set Environment Variables With System Lambda</a></li>
<li><a href="#orgc767032">6.2. Limitations of System Rules and System Lambda</a></li>
</ul>
</li>
<li><a href="#org2754595">7. Avoid Mocking Environment Variables</a>
<ul>
<li><a href="#org4487d8d">7.1. Maybe It Is Too Risky</a></li>
<li><a href="#org4bd4f34">7.2. Use Dependency Injection</a></li>
<li><a href="#org9495604">7.3. Use an Abstraction</a></li>
</ul>
</li>
<li><a href="#org95596b8">8. Conclusion</a></li>
</ul>
</div>
</div>
<div id="outline-container-orgbf5e2f8" class="outline-2">
<h2 id="orgbf5e2f8"><span class="section-number-2">1.</span> 原文地址</h2>
<div class="outline-text-2" id="text-1">
<p>
<a href="https://www.baeldung.com/java-unit-testing-environment-variables">https://www.baeldung.com/java-unit-testing-environment-variables</a>
</p>
</div>
</div>
<div id="outline-container-org9942a9b" class="outline-2">
<h2 id="org9942a9b"><span class="section-number-2">2.</span> Overview</h2>
<div class="outline-text-2" id="text-2">
<div class="preview" id="org828e4a2">
<p>
When we’re unit testing code that depends on environment variables, we may wish to provide specific values for them as part of our test implementation.
</p>

<p>
Java doesn’t allow us to edit the environment variables, but there are workarounds we can use, and some libraries which can help us.
</p>

<p>
In this tutorial we’ll look at the challenges of depending on environment variables in unit tests, how Java has made this even harder in recent versions, and the JUnit Pioneer, System Stubs, System Lambda and System Rules libraries. We’ll look at this for JUnit 4, JUnit 5 and TestNG.
</p>

</div>
</div>
</div>
<div id="outline-container-org346610d" class="outline-2">
<h2 id="org346610d"><span class="section-number-2">3.</span> The Challenge of Changing Environment Variables</h2>
<div class="outline-text-2" id="text-3">
<p>
In other languages, such as JavaScript, we can very easily modify the environment in a test:
</p>
<div class="org-src-container">
<pre class="src src-java">beforeEach<span style="color: #4f97d7;">(</span><span style="color: #bc6ec5;">()</span> =&gt; <span style="color: #bc6ec5;">{</span>
   <span style="color: #a45bad;">process</span>.<span style="color: #a45bad;">env</span>.MY_VARIABLE = <span style="color: #dc752f; background-color: #292b2e;">'</span>set<span style="color: #dc752f; background-color: #292b2e;">'</span>;
<span style="color: #bc6ec5;">}</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>

<p>
Java is a lot more strict. In Java, the environment variable map is immutable. It’s an unmodifiable Map that is initialized when the JVM starts. While there are good reasons for this, we may still wish to control our environment at test time.
</p>
</div>
<div id="outline-container-org78ee8ce" class="outline-3">
<h3 id="org78ee8ce"><span class="section-number-3">3.1.</span> Why the Environment Is Immutable</h3>
<div class="outline-text-3" id="text-3-1">
<p>
With the normal execution of Java programs, it could be potentially chaotic if something as global as the runtime environment config could be modified. This is especially risky when multiple threads are involved. For example, one thread might be modifying the environment at the same time as another, launching a process with that environment, and any conflicting settings may interact in unexpected ways.
</p>

<p>
The designers of Java have, therefore, kept the global values in the environment variables map safe. In contrast, system properties are easily changed at runtime.
</p>
</div>
</div>
<div id="outline-container-org4953067" class="outline-3">
<h3 id="org4953067"><span class="section-number-3">3.2.</span> Working Around the Unmodifiable Map</h3>
<div class="outline-text-3" id="text-3-2">
<p>
There is a workaround for the immutable environment variables Map object. Despite its read only UnmodifiableMap type, we can break encapsulation and access an internal field using reflection:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ce537a; font-weight: bold;">Class</span><span style="color: #4f97d7;">&lt;</span>?<span style="color: #4f97d7;">&gt;</span> <span style="color: #7590db;">classOfMap</span> = System.getenv<span style="color: #4f97d7;">()</span>.getClass<span style="color: #4f97d7;">()</span>;
<span style="color: #ce537a; font-weight: bold;">Field</span> <span style="color: #7590db;">field</span> = classOfMap.getDeclaredField<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"m"</span><span style="color: #4f97d7;">)</span>;
field.setAccessible<span style="color: #4f97d7;">(</span><span style="color: #a45bad;">true</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #4f97d7;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span>, <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #4f97d7;">&gt;</span> <span style="color: #7590db;">writeableEnvironmentVariables</span> = <span style="color: #4f97d7;">(</span><span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #bc6ec5;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span>, <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #bc6ec5;">&gt;</span><span style="color: #4f97d7;">)</span>field.get<span style="color: #4f97d7;">(</span>System.getenv<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
The field m inside the UnmodifiableMap wrapper object is a mutable Map that we can change:
</p>

<p>
writeableEnvironmentVariables.put("baeldung", "has set an environment variable");
assertThat(System.getenv("baeldung")).isEqualTo("has set an environment variable");
</p>

<p>
In practice, on Windows, there’s an alternative implementation of ProcessEnvironment that also accounts for case insensitive environment variables, so libraries that use the above technique have to account for this too. However, in principle, this is how we can work around the immutable environment variables Map.
</p>

<p>
After JDK 16, the module system became much more protective of the internals of the JDK, and using this reflective access has become more difficult.
</p>
</div>
</div>
<div id="outline-container-orgde8978a" class="outline-3">
<h3 id="orgde8978a"><span class="section-number-3">3.3.</span> When Reflective Access Doesn’t Work</h3>
<div class="outline-text-3" id="text-3-3">
<p>
The Java module system has disabled reflective modification of its core internals by default since JDK 17. These are considered unsafe practices which could lead to runtime errors if the internals changed in the future.
</p>

<p>
We may receive an error like this:
</p>

<p>
Unable to make field private static final java.util.HashMap java.lang.ProcessEnvironment.theEnvironment accessible: 
  module java.base does not "opens java.lang" to unnamed module @fdefd3f
</p>

<p>
This is an indication that the Java module system is preventing the use of reflection. This can be fixed by adding some extra command line parameters to our test runner config in pom.xml to use &gt;–add-opens to permit this reflective access:
</p>

<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #bc6ec5; font-weight: bold;">plugin</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;org.apache.maven.plugins&lt;/<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;maven-surefire-plugin&lt;/<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">configuration</span>&gt;
        &lt;<span style="color: #bc6ec5; font-weight: bold;">argLine</span>&gt;
            --add-opens java.base/java.util=ALL-UNNAMED
            --add-opens java.base/java.lang=ALL-UNNAMED
        &lt;/<span style="color: #bc6ec5; font-weight: bold;">argLine</span>&gt;
    &lt;/<span style="color: #bc6ec5; font-weight: bold;">configuration</span>&gt;
&lt;/<span style="color: #bc6ec5; font-weight: bold;">plugin</span>&gt;
</pre>
</div>
<p>
This workaround allows us to write code and use tools that break encapsulation via reflection. However, we may wish to avoid this, as the opening of these modules may allow for unsafe coding practices that work at test time but unexpectedly fail at runtime. We can instead choose tooling that doesn’t require this workaround.
</p>
</div>
</div>
<div id="outline-container-org08a7ffb" class="outline-3">
<h3 id="org08a7ffb"><span class="section-number-3">3.4.</span> Why We Need to Set Environment Variables Programmatically</h3>
<div class="outline-text-3" id="text-3-4">
<p>
It’s possible for our unit tests to be run with environment variables set by the test runner. This may be our first preference if we have global configuration that applies across the entire test suite.
</p>

<p>
We can achieve this by adding an environment variable to our surefire configuration in our pom.xml:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #bc6ec5; font-weight: bold;">plugin</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;org.apache.maven.plugins&lt;/<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;maven-surefire-plugin&lt;/<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">configuration</span>&gt;
        &lt;<span style="color: #bc6ec5; font-weight: bold;">environmentVariables</span>&gt;
            &lt;<span style="color: #bc6ec5; font-weight: bold;">SET_BY_SUREFIRE</span>&gt;YES&lt;/<span style="color: #bc6ec5; font-weight: bold;">SET_BY_SUREFIRE</span>&gt;
        &lt;/<span style="color: #bc6ec5; font-weight: bold;">environmentVariables</span>&gt;
    &lt;/<span style="color: #bc6ec5; font-weight: bold;">configuration</span>&gt;
&lt;/<span style="color: #bc6ec5; font-weight: bold;">plugin</span>&gt;
</pre>
</div>
<p>
This variable is then visible to our tests:
</p>
<div class="org-src-container">
<pre class="src src-java">assertThat<span style="color: #4f97d7;">(</span>System.getenv<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"SET_BY_SUREFIRE"</span><span style="color: #bc6ec5;">)</span><span style="color: #4f97d7;">)</span>.isEqualTo<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"YES"</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
However, we may have code that operates differently depending on differing environment variable settings. We might prefer to be able to test all variations of this behaviour, using different values of an environment variable in different test cases.
</p>

<p>
Similarly, we may have values at test time that aren’t predictable at coding time. A good example of this is the port that we’re running a WireMock or test database in a docker container.
</p>
</div>
</div>
<div id="outline-container-orgb12d192" class="outline-3">
<h3 id="orgb12d192"><span class="section-number-3">3.5.</span> Getting the Right Help From Test Libraries</h3>
<div class="outline-text-3" id="text-3-5">
<p>
There are several test libraries that can help us set environment variables at test time. Each has their own level of compatibility with different test frameworks, and JDK versions.
</p>

<p>
We can choose the right library based on our preferred workflow, whether the environment variable’s value is known ahead of time, and which JDK version we’re planning to use.
</p>

<p>
We should note that all of these libraries cover more than just environment variables. They all use the approach of capturing the current environment before they make changes and returning the environment back to how it was after the test is complete.
</p>
</div>
</div>
</div>
<div id="outline-container-orgdee55a8" class="outline-2">
<h2 id="orgdee55a8"><span class="section-number-2">4.</span> Setting Environment Variables With JUnit Pioneer</h2>
<div class="outline-text-2" id="text-4">
<p>
JUnit Pioneer is a set of extensions for JUnit 5. It offers an annotation-based way to set and clear environment variables.
</p>

<p>
We can add it with the junit-pioneer dependency:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;org.junit-pioneer&lt;/<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;junit-pioneer&lt;/<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;2.1.0&lt;/<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;test&lt;/<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;
&lt;/<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
</pre>
</div>
</div>
<div id="outline-container-org5db6e65" class="outline-3">
<h3 id="org5db6e65"><span class="section-number-3">4.1.</span> Using the SetEnvironmentVariable Annotation</h3>
<div class="outline-text-3" id="text-4-1">
<p>
We can annotate a test class or method with the SetEnvironmentVariable annotation, and our test code operates with that value set in the environment:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@SetEnvironmentVariable</span><span style="color: #4f97d7;">(</span>key = <span style="color: #2d9574;">"pioneer"</span>, value = <span style="color: #2d9574;">"is pioneering"</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariablesSetByJUnitPioneerUnitTest</span> <span style="color: #4f97d7;">{</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
We should note that the key and value must be known at compile time.
</p>

<p>
Our test can then use the environment variable:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Test</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">variableCanBeRead</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    assertThat<span style="color: #bc6ec5;">(</span>System.getenv<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"pioneer"</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>.isEqualTo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"is pioneering"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
We can use the @SetEnvironmentVariable annotation multiple times to set multiple variables.
</p>
</div>
</div>
<div id="outline-container-orgb453a57" class="outline-3">
<h3 id="orgb453a57"><span class="section-number-3">4.2.</span> Clearing an Environment Variable</h3>
<div class="outline-text-3" id="text-4-2">
<p>
We may also wish to clear system-provided environment variables, or even some that were set at class level for some specific tests:
</p>

<p>
@ClearEnvironmentVariable(key = "pioneer")
@Test
void givenEnvironmentVariableIsClear<sub>thenItIsNotSet</sub>() {
    assertThat(System.getenv("pioneer")).isNull();
}
</p>
</div>
</div>
<div id="outline-container-orge0ee184" class="outline-3">
<h3 id="orge0ee184"><span class="section-number-3">4.3.</span> Limitations of JUnit Pioneer</h3>
<div class="outline-text-3" id="text-4-3">
<p>
JUnit Pioneer can only be used with JUnit 5. It uses reflection, so it requires a version of Java from 16 or below, or for the add-opens workaround to be employed.
</p>
</div>
</div>
</div>
<div id="outline-container-org9a90a92" class="outline-2">
<h2 id="org9a90a92"><span class="section-number-2">5.</span> Setting Environment Variables With System Stubs</h2>
<div class="outline-text-2" id="text-5">
<p>
System Stubs has test support for JUnit 4, JUnit 5 and TestNG. Like its predecessor, System Lambda, it may also be used independently in the body of any test code in any framework. System Stubs is compatible with all versions of the JDK from 11 onwards.
</p>
</div>
<div id="outline-container-orgc97e3aa" class="outline-3">
<h3 id="orgc97e3aa"><span class="section-number-3">5.1.</span> Setting Environment Variables in JUnit 5</h3>
<div class="outline-text-3" id="text-5-1">
<p>
For this we need the System Stubs JUnit 5 dependency:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;uk.org.webcompere&lt;/<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;system-stubs-jupiter&lt;/<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;2.1.3&lt;/<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;test&lt;/<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;
&lt;/<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
</pre>
</div>

<p>
First we need to add the extension to our test class:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@ExtendWith</span><span style="color: #4f97d7;">(</span>SystemStubsExtension.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariablesUnitTest</span> <span style="color: #4f97d7;">{</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
We can initialise an EnvironmentVariables stub object as a field of the test class with the environment variables we wish to use:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@SystemStub</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariables</span> <span style="color: #7590db;">environment</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariables</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"MY VARIABLE"</span>, <span style="color: #2d9574;">"is set"</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
Notably, we must annotate the object with @SystemStub so the extension knows to work with it.
</p>

<p>
The SystemStubsExtension then activates this alternative environment during a test, and clears it up afterwards. During the test, the EnvironmentVariables object can also be modified and calls to System.getenv() receive the latest configuration.
</p>

<p>
Let’s also look at a more complex situation where we wish to set an environment variable with a value only known at test initialization time. In this case, as we’re going to provide a value in our beforeEach() method, we don’t need to create an instance of the object in our initializer list:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@SystemStub</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariables</span> <span style="color: #7590db;">environmentVariables</span>;
</pre>
</div>
<p>
By the time JUnit calls our beforeEach(), the extension has created the object for us, and we can use it set the environment variables we need:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@BeforeEach</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">beforeEach</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    environmentVariables.set<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"systemstubs"</span>, <span style="color: #2d9574;">"creates stub objects"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
When our test is executed, the environment variables will be active:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Test</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">givenEnvironmentVariableHasBeenSet_thenCanReadIt</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    assertThat<span style="color: #bc6ec5;">(</span>System.getenv<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"systemstubs"</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>.isEqualTo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"creates stub objects"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
After the test method has completed, the environment variables return to the state they were in before modification.
</p>
</div>
</div>
<div id="outline-container-org8d9aa54" class="outline-3">
<h3 id="org8d9aa54"><span class="section-number-3">5.2.</span> Setting Environment Variables in JUnit 4</h3>
<div class="outline-text-3" id="text-5-2">
<p>
For this we need the System Stubs JUnit 4 dependency:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;uk.org.webcompere&lt;/<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;system-stubs-junit4&lt;/<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;2.1.3&lt;/<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;test&lt;/<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;
&lt;/<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
</pre>
</div>
<p>
System Stubs provides a JUnit 4 rule. We add this as a field of our test class:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Rule</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariablesRule</span> <span style="color: #7590db;">environmentVariablesRule</span> =
  <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariablesRule</span><span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"system stubs"</span>, <span style="color: #2d9574;">"initializes variable"</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
Here we’ve initialized it with an environment variable. We can also call set() on the rule to modify the variables during our tests, or within our @Before method.
</p>

<p>
Once the test is running, the environment variable is active:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Test</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">canReadVariable</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    assertThat<span style="color: #bc6ec5;">(</span>System.getenv<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"system stubs"</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>.isEqualTo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"initializes variable"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org04f34b4" class="outline-3">
<h3 id="org04f34b4"><span class="section-number-3">5.3.</span> Setting Environment Variables in TestNG</h3>
<div class="outline-text-3" id="text-5-3">
<p>
For this we need the System Stubs TestNG dependency:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;uk.org.webcompere&lt;/<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;system-stubs-testng&lt;/<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;2.1.3&lt;/<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;test&lt;/<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;
&lt;/<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
</pre>
</div>
<p>
This provides a TestNG listener that works like the JUnit 5 solution above.
</p>

<p>
We add the listener to our test class:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Listeners</span><span style="color: #4f97d7;">(</span>SystemStubsListener.<span style="color: #4f97d7; font-weight: bold;">class</span><span style="color: #4f97d7;">)</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariablesTestNGUnitTest</span> <span style="color: #4f97d7;">{</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
Then we add an EnvironmentVariables field annotated with @SystemStub:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@SystemStub</span>
<span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariables</span> <span style="color: #7590db;">setEnvironment</span>;
</pre>
</div>
<p>
Then our beforeAll() method can initialise some variables:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@BeforeClass</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">beforeAll</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    setEnvironment.set<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"testng"</span>, <span style="color: #2d9574;">"has environment variables"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
And our test method can use them:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Test</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">givenEnvironmentVariableWasSet_thenItCanBeRead</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    assertThat<span style="color: #bc6ec5;">(</span>System.getenv<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"testng"</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>.isEqualTo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"has environment variables"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9768456" class="outline-3">
<h3 id="org9768456"><span class="section-number-3">5.4.</span> System Stubs Without a Test Framework</h3>
<div class="outline-text-3" id="text-5-4">
<p>
System Stubs was originally based on the codebase of System Lambda, which came with techniques that could only be used inside a single test method. This meant that the choice of test framework was completely open.
</p>

<p>
System Stubs Core, therefore, can be used to set environment variables anywhere in a JUnit test method.
</p>

<p>
First, let’s get the system-stubs-core dependency:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;uk.org.webcompere&lt;/<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;system-stubs-core&lt;/<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;2.1.3&lt;/<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;test&lt;/<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;
&lt;/<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
</pre>
</div>
<p>
Now, in one of our test methods, we can surround the test code with a construct that temporarily sets some environment variables. First we need to statically import from SystemStubs:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #a45bad;">uk</span>.<span style="color: #a45bad;">org</span>.<span style="color: #a45bad;">webcompere</span>.<span style="color: #a45bad;">systemstubs</span>.SystemStubs.<span style="color: #ce537a; font-weight: bold;">withEnvironmentVariables</span>;
</pre>
</div>
<p>
Then we can use the withEnvironmentVariables() method to wrap our test code:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Test</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">useEnvironmentVariables</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">Exception</span> <span style="color: #4f97d7;">{</span>
    withEnvironmentVariables<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system stubs"</span>, <span style="color: #2d9574;">"in test"</span><span style="color: #bc6ec5;">)</span>
      .execute<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">()</span> -&gt; <span style="color: #2d9574;">{</span>
          assertThat<span style="color: #67b11d;">(</span>System.getenv<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"system stubs"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
            .isEqualTo<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"in test"</span><span style="color: #67b11d;">)</span>;
      <span style="color: #2d9574;">}</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
Here we can see that the assertThat() call is an operation on an environment that has the variable set in it. Outside of the closure called by execute(), the environment variables are unaffected.
</p>

<p>
We should note that this technique requires our test to have throws Exception on our test method, since the execute() function has to cope with closures that may make calls to methods with checked exceptions.
</p>

<p>
This technique also requires each test to set its own environment, and doesn’t work well if we’re trying to work with test objects with a lifecycle larger than a single test, for example a Spring Context.
</p>

<p>
System Stubs allows each of its stub objects to be set up and torn down independently of a test framework. So, we could use the beforeAll() and afterAll() methods of a test class to manipulate our EnvironmentVariables object:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariables</span> <span style="color: #7590db;">environmentVariables</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariables</span><span style="color: #4f97d7;">()</span>;
<span style="color: #a45bad;">@BeforeAll</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">beforeAll</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">Exception</span> <span style="color: #4f97d7;">{</span>
    environmentVariables.set<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system stubs"</span>, <span style="color: #2d9574;">"in test"</span><span style="color: #bc6ec5;">)</span>;
    environmentVariables.setup<span style="color: #bc6ec5;">()</span>;
<span style="color: #4f97d7;">}</span>
<span style="color: #a45bad;">@AfterAll</span>
<span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">afterAll</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">Exception</span> <span style="color: #4f97d7;">{</span>
    environmentVariables.teardown<span style="color: #bc6ec5;">()</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
The benefit of the test framework extensions, however, is that we can avoid this sort of boilerplate, as they execute these basics for us.
</p>
</div>
</div>
<div id="outline-container-org2600290" class="outline-3">
<h3 id="org2600290"><span class="section-number-3">5.5.</span> Limitations of System Stubs</h3>
<div class="outline-text-3" id="text-5-5">
<p>
The TestNG capability of System Stubs is only available in the version 2.1+ releases, which are limited to Java 11 onwards.
</p>

<p>
In its version 2 release train, System Stubs deviated from the common reflection-based techniques described earlier. It now uses ByteBuddy to intercept environment variable calls. However, if a project uses a lower version of the JDK than 11, then there’s also no need to use these later versions.
</p>

<p>
System Stubs version 1 provides compatibility with JDK 8 to JDK 16.
</p>
</div>
</div>
</div>
<div id="outline-container-org590d002" class="outline-2">
<h2 id="org590d002"><span class="section-number-2">6.</span> System Rules and System Lambda</h2>
<div class="outline-text-2" id="text-6">
<p>
One of the longest-standing test libraries for environment variables, System Rules provided a JUnit 4 solution to setting environment variables, and its author replaced it with System Lambda to provide a test-framework agnostic approach. They’re based on the same core techniques for substituting environment variables at test time.
5.1. Set Environment Variables With System Rules
</p>

<p>
First we need the system-rules dependency:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;com.github.stefanbirkner&lt;/<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;system-rules&lt;/<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;1.19.0&lt;/<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;test&lt;/<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;
&lt;/<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
</pre>
</div>

<p>
Then we add the rule to our JUnit 4 test class:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Rule</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariables</span> <span style="color: #7590db;">environmentVariablesRule</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">EnvironmentVariables</span><span style="color: #4f97d7;">()</span>;
</pre>
</div>
<p>
We can set up the values in our @Before method:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Before</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">before</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    environmentVariablesRule.set<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system rules"</span>, <span style="color: #2d9574;">"works"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
And access the correct environment in our test method:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Test</span>
<span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">givenEnvironmentVariable_thenCanReadIt</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7;">{</span>
    assertThat<span style="color: #bc6ec5;">(</span>System.getenv<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"system rules"</span><span style="color: #2d9574;">)</span><span style="color: #bc6ec5;">)</span>.isEqualTo<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"works"</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
The rule object – environmentVariablesRule – allows us to set environment variables immediately within the test method too.
</p>
</div>
<div id="outline-container-orgd645dd0" class="outline-3">
<h3 id="orgd645dd0"><span class="section-number-3">6.1.</span> Set Environment Variables With System Lambda</h3>
<div class="outline-text-3" id="text-6-1">
<p>
For this we need the system-lambda dependency:
</p>
<div class="org-src-container">
<pre class="src src-xml">&lt;<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;com.github.stefanbirkner&lt;/<span style="color: #bc6ec5; font-weight: bold;">groupId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;system-lambda&lt;/<span style="color: #bc6ec5; font-weight: bold;">artifactId</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;1.2.1&lt;/<span style="color: #bc6ec5; font-weight: bold;">version</span>&gt;
    &lt;<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;test&lt;/<span style="color: #bc6ec5; font-weight: bold;">scope</span>&gt;
&lt;/<span style="color: #bc6ec5; font-weight: bold;">dependency</span>&gt;
</pre>
</div>
<p>
As already demonstrated in the System Stubs solution, we can put the code that depends on the environment within a closure in our test. For this we should statically import SystemLambda:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">import</span> <span style="color: #4f97d7; font-weight: bold;">static</span> <span style="color: #a45bad;">com</span>.<span style="color: #a45bad;">github</span>.<span style="color: #a45bad;">stefanbirkner</span>.<span style="color: #a45bad;">systemlambda</span>.SystemLambda.<span style="color: #ce537a; font-weight: bold;">withEnvironmentVariable</span>;
</pre>
</div>
<p>
Then we can write the test:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@Test</span>
<span style="color: #ce537a; font-weight: bold;">void</span> <span style="color: #bc6ec5; font-weight: bold;">enviromentVariableIsSet</span><span style="color: #4f97d7;">()</span> <span style="color: #4f97d7; font-weight: bold;">throws</span> <span style="color: #ce537a; font-weight: bold;">Exception</span> <span style="color: #4f97d7;">{</span>
    withEnvironmentVariable<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">"system lambda"</span>, <span style="color: #2d9574;">"in test"</span><span style="color: #bc6ec5;">)</span>
      .execute<span style="color: #bc6ec5;">(</span><span style="color: #2d9574;">()</span> -&gt; <span style="color: #2d9574;">{</span>
          assertThat<span style="color: #67b11d;">(</span>System.getenv<span style="color: #b1951d;">(</span><span style="color: #2d9574;">"system lambda"</span><span style="color: #b1951d;">)</span><span style="color: #67b11d;">)</span>
            .isEqualTo<span style="color: #67b11d;">(</span><span style="color: #2d9574;">"in test"</span><span style="color: #67b11d;">)</span>;
      <span style="color: #2d9574;">}</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc767032" class="outline-3">
<h3 id="orgc767032"><span class="section-number-3">6.2.</span> Limitations of System Rules and System Lambda</h3>
<div class="outline-text-3" id="text-6-2">
<p>
While these are both mature and broad libraries, they cannot be used for manipulating environment variables in JDK 17 and beyond.
</p>

<p>
System Rules depends heavily on JUnit 4. We cannot use System Lambda for setting test-fixture wide environment variables, so it cannot help us with Spring context initialization.
</p>
</div>
</div>
</div>
<div id="outline-container-org2754595" class="outline-2">
<h2 id="org2754595"><span class="section-number-2">7.</span> Avoid Mocking Environment Variables</h2>
<div class="outline-text-2" id="text-7">
<p>
While we have discussed a number of ways to modify environment variables at test time, it may be worth considering whether this is necessary, or even beneficial.
</p>
</div>
<div id="outline-container-org4487d8d" class="outline-3">
<h3 id="org4487d8d"><span class="section-number-3">7.1.</span> Maybe It Is Too Risky</h3>
<div class="outline-text-3" id="text-7-1">
<p>
As we’ve seen with each of the solutions above, changing the environment variables at runtime is not straightforward. In cases where there is multi-threaded code, it can be even more tricky. If multiple test fixture are running in the same JVM in parallel, perhaps with JUnit 5’s concurrency features, then there is a risk that different tests may be trying to take control of the environment at the same time in a contradictory way.
</p>

<p>
Though some of the testing libraries above may not crash when used simultaneously by multiple threads, it would be hard to predict how the environment variables might be set from one moment to the next. Even worse, it’s possible that one thread might capture another test’s temporary environment variables as though they were the correct state to leave the system in when the tests are all finished.
</p>

<p>
As an example from another test library, when Mockito mocks static methods, it limits that to the current thread, since such mocking globals can break concurrent tests. As such, modifying environment variables encounters exactly the same risks. One test can affect the entire global state of the JVM and cause side effects elsewhere.
</p>

<p>
Similarly, if we’re running code that we can only control through environment variables, it can be very difficult to test, and surely we could avoid that by design?
</p>
</div>
</div>
<div id="outline-container-org4bd4f34" class="outline-3">
<h3 id="org4bd4f34"><span class="section-number-3">7.2.</span> Use Dependency Injection</h3>
<div class="outline-text-3" id="text-7-2">
<p>
It’s easier to test a system that receives all its inputs at construction, than one that pulls its inputs from system resources.
</p>

<p>
Dependency injection containers such as Spring allow us to build objects that are much easier to test in isolation of the runtime.
</p>

<p>
We should also note that Spring will allow us to use system properties in place of environment variables to set any of its property values. Each of the tools we’ve discussed in this article also supports setting and resetting system properties at test time.
</p>
</div>
</div>
<div id="outline-container-org9495604" class="outline-3">
<h3 id="org9495604"><span class="section-number-3">7.3.</span> Use an Abstraction</h3>
<div class="outline-text-3" id="text-7-3">
<p>
If a module must pull environment variables, perhaps it should not depend directly on System.getenv() but could instead use an environment variable reader interface:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #a45bad;">@FunctionalInterface</span>
<span style="color: #4f97d7; font-weight: bold;">interface</span> <span style="color: #ce537a; font-weight: bold;">GetEnv</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #bc6ec5; font-weight: bold;">get</span><span style="color: #bc6ec5;">(</span><span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #7590db;">name</span><span style="color: #bc6ec5;">)</span>;
<span style="color: #4f97d7;">}</span>
</pre>
</div>
<p>
The system code could then have an object of this injected via constructor:
</p>

<div class="org-src-container">
<pre class="src src-java"><span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #4f97d7; font-weight: bold;">class</span> <span style="color: #ce537a; font-weight: bold;">ReadsEnvironment</span> <span style="color: #4f97d7;">{</span>
    <span style="color: #4f97d7; font-weight: bold;">private</span> <span style="color: #ce537a; font-weight: bold;">GetEnv</span> <span style="color: #7590db;">getEnv</span>;
    <span style="color: #4f97d7; font-weight: bold;">public</span> ReadsEnvironment<span style="color: #bc6ec5;">(</span>GetEnv getEnv<span style="color: #bc6ec5;">)</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">this</span>.getEnv = getEnv;
    <span style="color: #bc6ec5;">}</span>
    <span style="color: #4f97d7; font-weight: bold;">public</span> <span style="color: #ce537a; font-weight: bold;">String</span> <span style="color: #bc6ec5; font-weight: bold;">whatOs</span><span style="color: #bc6ec5;">()</span> <span style="color: #bc6ec5;">{</span>
        <span style="color: #4f97d7; font-weight: bold;">return</span> getEnv.get<span style="color: #2d9574;">(</span><span style="color: #2d9574;">"OS"</span><span style="color: #2d9574;">)</span>;
    <span style="color: #bc6ec5;">}</span>
<span style="color: #4f97d7;">}</span>
</pre>
</div>

<p>
While at runtime, we might instantiate it with System::getenv, at test time we could pass in our own alternative environment:
</p>
<div class="org-src-container">
<pre class="src src-java"><span style="color: #ce537a; font-weight: bold;">Map</span><span style="color: #4f97d7;">&lt;</span><span style="color: #ce537a; font-weight: bold;">String</span>, <span style="color: #ce537a; font-weight: bold;">String</span><span style="color: #4f97d7;">&gt;</span> <span style="color: #7590db;">fakeEnv</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">HashMap</span><span style="color: #4f97d7;">&lt;&gt;()</span>;
fakeEnv.put<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"OS"</span>, <span style="color: #2d9574;">"MacDowsNix"</span><span style="color: #4f97d7;">)</span>;
<span style="color: #ce537a; font-weight: bold;">ReadsEnvironment</span> <span style="color: #7590db;">reader</span> = <span style="color: #4f97d7; font-weight: bold;">new</span> <span style="color: #ce537a; font-weight: bold;">ReadsEnvironment</span><span style="color: #4f97d7;">(</span>fakeEnv::get<span style="color: #4f97d7;">)</span>;
assertThat<span style="color: #4f97d7;">(</span>reader.whatOs<span style="color: #bc6ec5;">()</span><span style="color: #4f97d7;">)</span>.isEqualTo<span style="color: #4f97d7;">(</span><span style="color: #2d9574;">"MacDowsNix"</span><span style="color: #4f97d7;">)</span>;
</pre>
</div>
<p>
However, these alternatives to environment variables may seem very heavy, and leave us wishing Java gave us the control we saw with the JavaScript example earlier. Similarly, we cannot control code written by others, that may depend on environment variables.
</p>

<p>
Therefore, it seems inevitable that we may still encounter cases where we want to be able to control some environment variables dynamically at test time.
</p>
</div>
</div>
</div>
<div id="outline-container-org95596b8" class="outline-2">
<h2 id="org95596b8"><span class="section-number-2">8.</span> Conclusion</h2>
<div class="outline-text-2" id="text-8">
<p>
In this article we’ve looked at the options for setting environment variables at test time. We saw that this becomes more difficult to do when we need to be able to make those variables flexible at runtime, and available to JDK 17 and beyond.
</p>

<p>
Then, we discussed whether we can avoid the issue altogether if we write our production code differently. We considered the risks associated with modifying the environment variables at test time, especially with concurrent tests.
</p>

<p>
We also explored four of the most popular libraries for setting environment variables at test time: JUnit Pioneer, System Stubs, System Rules, and System Lambda. Each of these offers a different way to solve the problem, with differing compatibility across JDK versions and test frameworks.
</p>

<p>
As always the example code for this article is available <a href="https://feeds.feedblitz.com/~/t/0/0/baeldung/~https://github.com/eugenp/tutorials/tree/master/testing-modules/testing-libraries-2">over on GitHub</a>.
</p>
</div>
</div>
</div>
<div id="postamble" class="status">
<div id="footer">
    Last updated 2023-12-06 三 18:07<br>
    Built with <a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.3 (<a href="https://orgmode.org">Org</a> mode 9.7.26).
</div>
</div>
</body>
</html>
